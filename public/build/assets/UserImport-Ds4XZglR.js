import{r as g,o as $,c as n,e,s as k,y as d,h as s,j as x,p as z,q as u,d as o,D as _,v as G,t as v,F as D,A as F}from"./vue-Bki0M6Jk.js";import{x as L}from"./primevue-BWgMG8pc.js";import{a as C}from"./app-BtTGz4Tf.js";import{_ as N}from"./_plugin-vue_export-helper-DlAUqK2U.js";const O={class:"user-import-page"},A={class:"header-section"},P={class:"header-content"},q={class:"main-grid"},H={class:"import-form"},J={class:"upload-section"},K={key:0,class:"upload-placeholder"},X={key:1,class:"selected-file"},W={class:"file-details"},Q={class:"import-actions"},Y={class:"template-content"},Z={class:"rombel-content"},ee={key:0,class:"rombel-list"},le={key:1,class:"no-rombel"},ae={class:"results-content"},se={class:"results-summary"},te={class:"result-item success"},oe={class:"result-item skipped"},ne={key:0,class:"errors-section"},ie={class:"errors-list"},re={class:"error-row"},de={class:"error-message"},ue={key:0,class:"more-errors"},ce={key:0,class:"loading-overlay"},me={class:"loading-content"},pe={__name:"UserImport",setup(ve){const m=L(),r=g(null),f=g(!1),y=g(!1),b=g(!1),h=g(!1),w=g([]),i=g(null),j=a=>{const l=a.target.files[0];l&&B(l)},E=a=>{h.value=!1;const l=a.dataTransfer.files[0];l&&B(l)},B=a=>{if(!["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","text/csv","text/plain"].includes(a.type)&&!a.name.match(/\.(xlsx|xls|csv|txt)$/i)){m.add({severity:"error",summary:"Error",detail:"Format file tidak didukung. Gunakan Excel (.xlsx, .xls) atau CSV (.csv)",life:5e3});return}if(a.size>10*1024*1024){m.add({severity:"error",summary:"Error",detail:"Ukuran file terlalu besar. Maksimal 10MB",life:5e3});return}r.value=a,i.value=null},M=()=>{r.value=null,i.value=null,document.querySelector(".file-input")&&(document.querySelector(".file-input").value="")},R=a=>{if(a===0)return"0 Bytes";const l=1024,t=["Bytes","KB","MB","GB"],p=Math.floor(Math.log(a)/Math.log(l));return parseFloat((a/Math.pow(l,p)).toFixed(2))+" "+t[p]},T=async()=>{if(!r.value){m.add({severity:"warn",summary:"Validasi",detail:"Silakan pilih file terlebih dahulu",life:3e3});return}f.value=!0;try{const a=new FormData;a.append("file",r.value),a.append("strategy","sync");const l=await C.post("/users/import",a,{headers:{"Content-Type":"multipart/form-data"}});if(l.data.success)i.value=l.data.data,m.add({severity:"success",summary:"Import Berhasil",detail:`${l.data.data.imported_count} users berhasil diimport`,life:5e3}),r.value=null,window.dispatchEvent(new CustomEvent("users-imported"));else throw new Error(l.data.message)}catch(a){console.error("Import error:",a);let l="Gagal import users";if(a.response?.data?.errors){const t=a.response.data.errors;l=Object.values(t).flat().join(", ")}else a.response?.data?.message?l=a.response.data.message:a.message&&(l=a.message);m.add({severity:"error",summary:"Import Gagal",detail:l,life:5e3})}finally{f.value=!1}},S=async()=>{y.value=!0;try{const a=await C.get("/users/import/template",{responseType:"blob"}),l=window.URL.createObjectURL(new Blob([a.data])),t=document.createElement("a");t.href=l,t.setAttribute("download","template_import_users.csv"),document.body.appendChild(t),t.click(),document.body.removeChild(t),window.URL.revokeObjectURL(l),m.add({severity:"success",summary:"Download Berhasil",detail:"Template berhasil diunduh",life:3e3})}catch(a){console.error("Download template error:",a),m.add({severity:"error",summary:"Download Gagal",detail:"Gagal mengunduh template",life:3e3})}finally{y.value=!1}},I=async()=>{b.value=!0;try{const a=await C.get("/users/import/rombel");if(a.data.success)w.value=a.data.data.available_rombel;else throw new Error(a.data.message)}catch(a){console.error("Load rombel error:",a),m.add({severity:"error",summary:"Error",detail:"Gagal memuat data rombel",life:3e3})}finally{b.value=!1}};return $(()=>{I()}),(a,l)=>{const t=x("Button"),p=x("Card"),U=x("ProgressSpinner");return o(),n("div",O,[e("div",A,[e("div",P,[l[4]||(l[4]=e("div",{class:"header-info"},[e("h1",{class:"page-title"},[e("i",{class:"pi pi-upload"}),s(" Import Users ")]),e("p",{class:"page-description"}," Import data pengguna dari file Excel atau CSV dengan auto-creation rombel ")],-1)),d(t,{icon:"pi pi-arrow-left",label:"Kembali",onClick:l[0]||(l[0]=c=>a.$router.push("/users")),class:"back-btn",size:"small"})])]),e("div",q,[d(p,{class:"import-form-card"},{title:u(()=>[...l[5]||(l[5]=[e("div",{class:"card-title"},[e("i",{class:"pi pi-file-import"}),s(" Upload File Import ")],-1)])]),content:u(()=>[e("div",H,[e("div",J,[e("div",{class:G(["upload-area",{"drag-over":h.value,"has-file":r.value}]),onDragover:l[1]||(l[1]=_(c=>h.value=!0,["prevent"])),onDragleave:l[2]||(l[2]=_(c=>h.value=!1,["prevent"])),onDrop:_(E,["prevent"]),onClick:l[3]||(l[3]=c=>a.$refs.fileInput.click())},[r.value?(o(),n("div",X,[l[7]||(l[7]=e("i",{class:"pi pi-file"},null,-1)),e("div",W,[e("h4",null,v(r.value.name),1),e("p",null,v(R(r.value.size)),1)]),d(t,{icon:"pi pi-times",onClick:_(M,["stop"]),class:"remove-file-btn",text:"",rounded:""})])):(o(),n("div",K,[...l[6]||(l[6]=[e("i",{class:"pi pi-cloud-upload"},null,-1),e("h3",null,"Drag & Drop File",-1),e("p",null,"atau klik untuk memilih file",-1),e("small",{class:"file-info"},"Mendukung: Excel (.xlsx, .xls) atau CSV (.csv) - Max 10MB",-1)])])),e("input",{ref:"fileInput",type:"file",accept:".xlsx,.xls,.csv,.txt",onChange:j,style:{display:"none"}},null,544)],34)]),e("div",Q,[d(t,{onClick:T,disabled:!r.value||f.value,loading:f.value,label:"Import Users",icon:"pi pi-upload",class:"import-btn"},null,8,["disabled","loading"])])])]),_:1}),d(p,{class:"template-card"},{title:u(()=>[...l[8]||(l[8]=[e("div",{class:"card-title"},[e("i",{class:"pi pi-download"}),s(" Template Import ")],-1)])]),content:u(()=>[e("div",Y,[l[9]||(l[9]=e("p",{class:"template-description"}," Download template untuk format import yang benar ",-1)),d(t,{onClick:S,disabled:y.value,loading:y.value,label:"Download Template",icon:"pi pi-file-download",class:"template-btn"},null,8,["disabled","loading"])])]),_:1}),d(p,{class:"instructions-card"},{title:u(()=>[...l[10]||(l[10]=[e("div",{class:"card-title"},[e("i",{class:"pi pi-info-circle"}),s(" Petunjuk Import ")],-1)])]),content:u(()=>[...l[11]||(l[11]=[e("div",{class:"instructions-content"},[e("div",{class:"instruction-section"},[e("h4",null,"Field Wajib (*)"),e("ul",null,[e("li",null,[e("strong",null,"name*"),s(" - Nama lengkap user")]),e("li",null,[e("strong",null,"role*"),s(" - Role (admin/user)")]),e("li",null,[e("strong",null,"tahun_angkatan*"),s(" - Tahun angkatan (contoh: 2024) [tabel: rombongan_belajar]")]),e("li",null,[e("strong",null,"nama_rombel*"),s(" - Nama rombel (contoh: XII-A) [tabel: rombongan_belajar]")]),e("li",null,[e("strong",null,"tingkat*"),s(" - Tingkat kelas (contoh: XII) [tabel: rombongan_belajar]")])])]),e("div",{class:"instruction-section"},[e("h4",null,"Field Opsional"),e("ul",null,[e("li",null,[e("strong",null,"email"),s(" - Email (akan digenerate otomatis jika kosong)")]),e("li",null,[e("strong",null,"nisn"),s(" - Nomor induk siswa nasional (opsional, max 20 karakter)")]),e("li",null,[e("strong",null,"gender"),s(" - Jenis kelamin (L/P)")])])]),e("div",{class:"instruction-section"},[e("h4",null,"Auto-Creation Rombel (Tabel: rombongan_belajar)"),e("ul",null,[e("li",null,[e("strong",null,"Rombel baru akan dibuat otomatis"),s(" jika belum ada di tabel")]),e("li",null,[s("Sistem akan mencocokkan berdasarkan "),e("strong",null,"nama_rombel + tingkat + tahun_angkatan")]),e("li",null,"Jika rombel sudah ada, user akan langsung diattach ke rombel tersebut"),e("li",null,[s("Field di tabel: "),e("code",null,"nama_rombel"),s(", "),e("code",null,"tingkat"),s(", "),e("code",null,"tahun_angkatan")])])]),e("div",{class:"instruction-section"},[e("h4",null,"Catatan"),e("ul",null,[e("li",null,[s("Password default: "),e("code",null,"password")]),e("li",null,"Email akan digenerate otomatis jika tidak diisi (format: namasiswa@snesa.local)"),e("li",null,"Hanya admin yang bisa melakukan import"),e("li",null,"File yang error akan dilewati dengan pesan error"),e("li",null,"Rombel yang sama tidak akan dibuat duplikatnya")])])],-1)])]),_:1}),d(p,{class:"rombel-card"},{title:u(()=>[...l[12]||(l[12]=[e("div",{class:"card-title"},[e("i",{class:"pi pi-users"}),s(" Rombel Tersedia ")],-1)])]),content:u(()=>[e("div",Z,[d(t,{onClick:I,disabled:b.value,loading:b.value,label:"Refresh Rombel",icon:"pi pi-refresh",severity:"secondary",size:"small",class:"refresh-rombel-btn"},null,8,["disabled","loading"]),w.value.length>0?(o(),n("div",ee,[(o(!0),n(D,null,F(w.value,c=>(o(),n("div",{key:c,class:"rombel-chip"},v(c),1))),128))])):b.value?k("",!0):(o(),n("div",le,[...l[13]||(l[13]=[e("i",{class:"pi pi-info-circle"},null,-1),e("p",null,"Belum ada data rombel",-1)])]))])]),_:1}),i.value?(o(),z(p,{key:0,class:"results-card"},{title:u(()=>[...l[14]||(l[14]=[e("div",{class:"card-title"},[e("i",{class:"pi pi-check-circle"}),s(" Hasil Import ")],-1)])]),content:u(()=>[e("div",ae,[e("div",se,[e("div",te,[l[16]||(l[16]=e("i",{class:"pi pi-check"},null,-1)),e("div",null,[e("strong",null,v(i.value.imported_count),1),l[15]||(l[15]=e("span",null,"Berhasil diimport",-1))])]),e("div",oe,[l[18]||(l[18]=e("i",{class:"pi pi-exclamation-triangle"},null,-1)),e("div",null,[e("strong",null,v(i.value.skipped_count),1),l[17]||(l[17]=e("span",null,"Dilewati/Error",-1))])])]),i.value.errors&&i.value.errors.length>0?(o(),n("div",ne,[l[19]||(l[19]=e("h4",null,"Detail Error",-1)),e("div",ie,[(o(!0),n(D,null,F(i.value.errors.slice(0,10),(c,V)=>(o(),n("div",{key:V,class:"error-item"},[e("span",re,"Baris "+v(c.row)+":",1),e("span",de,v(Object.values(c.errors).join(", ")),1)]))),128)),i.value.errors.length>10?(o(),n("div",ue," ... dan "+v(i.value.errors.length-10)+" error lainnya ",1)):k("",!0)])])):k("",!0)])]),_:1})):k("",!0)]),f.value?(o(),n("div",ce,[e("div",me,[d(U),l[20]||(l[20]=e("h3",null,"Mengimport Users...",-1)),l[21]||(l[21]=e("p",null,"Mohon tunggu, sedang memproses file",-1))])])):k("",!0)])}}},ye=N(pe,[["__scopeId","data-v-5be0a1d8"]]);export{ye as default};
