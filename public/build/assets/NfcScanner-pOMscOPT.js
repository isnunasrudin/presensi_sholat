import{r as i,o as O,S as q,c as f,e as a,y as d,q as _,j as k,d as g,s as E,v as T,t as p,F as J,A as Y}from"./vue-Bki0M6Jk.js";import{u as Q}from"./primevue-DK4246gS.js";import{a as L}from"./app-Brb7QJ--.js";import{_ as X}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Z={class:"nfc-scanner"},ee={class:"selection-form"},ae={class:"field"},te={class:"field"},se={class:"field"},ne={key:0,class:"scan-status"},le={class:"status-indicator"},re={key:1,class:"detected-card"},oe={class:"card-info"},ie={class:"card-details"},ue={class:"card-url"},de={key:2,class:"user-info"},ce={class:"user-card"},ve={class:"user-details"},pe={class:"action-buttons"},me={key:3,class:"scan-history"},fe={class:"history-content"},ge={class:"history-user"},ye={class:"history-time"},he={class:"confirmation-content"},be={__name:"NfcScanner",setup(ke){const l=Q(),c=i(!1),w=i(new Date),N=i(null),y=i(null),v=i(null),h=i(!1),x=i(""),b=i([]),m=i(null),r=i(!1),D=i(null),V=i(3e3),$=[{label:"Dhuhur",value:"dhuhur"},{label:"Dhuha",value:"dhuha"}],B=()=>{c.value?U():M()},M=async()=>{if(!w.value||!N.value){l.add({severity:"warn",summary:"Peringatan",detail:"Harap pilih tanggal dan jenis sholat terlebih dahulu",life:3e3});return}c.value=!0,l.add({severity:"info",summary:"Scan Dimulai",detail:"Menunggu kartu NFC...",life:3e3}),await R()},U=()=>{c.value=!1,r.value=!1,m.value&&(m.value=null),y.value=null,v.value=null,D.value=null,l.add({severity:"info",summary:"Scan Dihentikan",detail:"Scan NFC telah dihentikan",life:3e3})},W=t=>{if(!D.value)return!1;const e=Date.now()-new Date(D.value.timestamp).getTime(),n=D.value.url===t,s=e<V.value;return n&&s},R=async()=>{if(!("NDEFReader"in window)){l.add({severity:"warn",summary:"Peringatan",detail:"NFC tidak didukung di browser ini. Gunakan browser yang mendukung Web NFC API.",life:5e3}),c.value=!1;return}try{m.value=new NDEFReader,await m.value.scan(),m.value.addEventListener("reading",({message:t,serialNumber:e})=>{if(r.value){console.log("Already processing a card, ignoring...");return}if(t.records.length>0){const n=t.records[0];let s="";try{if(n.recordType==="url")s=new TextDecoder().decode(n.data);else if(n.recordType==="text"){const C=new TextDecoder().decode(n.data);(C.startsWith("http://")||C.startsWith("https://"))&&(s=C)}else s=new TextDecoder().decode(n.data)}catch(S){console.error("Error decoding NFC data:",S),l.add({severity:"error",summary:"Error",detail:"Gagal membaca data NFC",life:3e3});return}if(!s||!s.includes("/u/")){l.add({severity:"warn",summary:"Peringatan",detail:"Kartu NFC tidak valid atau tidak mengandung URL pengguna",life:3e3});return}if(W(s)){console.log("Duplicate scan detected, ignoring...");return}r.value=!0,y.value={url:s,serialNumber:e,timestamp:new Date},D.value={url:s,timestamp:new Date};const u=s.split("/").pop();u?j(u):(l.add({severity:"error",summary:"Error",detail:"Format URL tidak valid",life:3e3}),r.value=!1)}}),m.value.addEventListener("error",t=>{console.error("NFC scan error:",t),l.add({severity:"error",summary:"Error NFC",detail:"Terjadi kesalahan saat membaca NFC: "+t.message,life:3e3}),r.value=!1})}catch(t){console.error("NFC initialization error:",t),l.add({severity:"error",summary:"Error",detail:"Gagal mengaktifkan NFC: "+t.message,life:3e3}),c.value=!1,r.value=!1}},j=async t=>{try{const e=await L.get(`/users/${t}`);v.value=e.data.data||e.data,x.value=v.value.name,h.value=!0}catch(e){console.error("Error fetching user info:",e),l.add({severity:"error",summary:"Error",detail:"Gagal mengambil informasi pengguna. Pastikan kartu NFC terdaftar.",life:3e3}),r.value=!1,y.value=null}},I=t=>{h.value=!0},P=async t=>{try{h.value=!1;const e=await L.post("/prayer-records",{user_id:v.value.id,prayer_type:N.value,date:G(w.value),status:t,notes:`Dicatat melalui scan NFC pada ${new Date().toLocaleString("id-ID")}`});b.value.unshift({userName:v.value.name,status:t,statusLabel:A(t),time:new Date().toLocaleTimeString()}),b.value.length>10&&(b.value=b.value.slice(0,10));const n=v.value?.name||"pengguna";y.value=null,v.value=null,r.value=!1,l.add({severity:"success",summary:"Berhasil",detail:`Kehadiran ${n} telah dicatat sebagai ${A(t)}`,life:3e3})}catch(e){console.error("Error recording attendance:",e);let n="Gagal mencatat kehadiran";if(e.response?.status===422){const s=e.response.data.errors;s&&Object.keys(s).length>0&&(n=Object.values(s)[0][0])}else e.response?.data?.message?n=e.response.data.message:e.message&&(n=e.message);l.add({severity:"error",summary:"Error",detail:n,life:5e3}),r.value=!1}},G=t=>{if(!t)return null;const e=new Date(t),n=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),u=String(e.getDate()).padStart(2,"0");return`${n}-${s}-${u}`},A=t=>{switch(t){case"sholat":return"Sholat";case"tidak_sholat":return"Tidak Sholat";case"halangan":return"Halangan";default:return t}},K=t=>t.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"});return O(()=>{"NDEFReader"in window?(console.log("Web NFC API is supported"),l.add({severity:"info",summary:"Info",detail:"Web NFC API didukung. Siap untuk scan NFC.",life:3e3})):(console.log("Web NFC API is not supported in this browser"),l.add({severity:"warn",summary:"Peringatan",detail:"Web NFC API tidak didukung di browser ini. Gunakan Chrome/Edge di Android.",life:7e3}))}),q(()=>{m.value&&(m.value=null),r.value=!1,c.value=!1}),(t,e)=>{const n=k("Calendar"),s=k("Dropdown"),u=k("Button"),S=k("DataView"),C=k("Card"),H=k("Dialog");return g(),f("div",Z,[e[19]||(e[19]=a("div",{class:"page-header"},[a("h1",{class:"page-title"},"Scan NFC Kehadiran Sholat")],-1)),d(C,null,{content:_(()=>[a("div",ee,[a("div",ae,[e[8]||(e[8]=a("label",{for:"prayerDate"},"Tanggal Sholat",-1)),d(n,{id:"prayerDate",modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=o=>w.value=o),dateFormat:"yy-mm-dd",showIcon:!0,maxDate:new Date},null,8,["modelValue","maxDate"])]),a("div",te,[e[9]||(e[9]=a("label",{for:"prayerType"},"Jenis Sholat",-1)),d(s,{id:"prayerType",modelValue:N.value,"onUpdate:modelValue":e[1]||(e[1]=o=>N.value=o),options:$,optionLabel:"label",optionValue:"value",placeholder:"Pilih jenis sholat"},null,8,["modelValue"])]),a("div",se,[e[10]||(e[10]=a("label",null,"Â ",-1)),d(u,{label:c.value?"Hentikan Scan":"Mulai Scan",icon:c.value?"pi pi-stop":"pi pi-play",onClick:B,class:T(c.value?"p-button-danger":"p-button-success")},null,8,["label","icon","class"])])]),c.value?(g(),f("div",ne,[a("div",le,[a("i",{class:T(["pi status-icon",r.value?"pi-spin pi-spinner":"pi-wifi"])},null,2),a("span",null,p(r.value?"Memproses kartu...":"Menunggu kartu NFC..."),1)])])):E("",!0),y.value?(g(),f("div",re,[e[13]||(e[13]=a("h3",null,"Kartu Terdeteksi",-1)),a("div",oe,[e[12]||(e[12]=a("i",{class:"pi pi-user card-icon"},null,-1)),a("div",ie,[a("p",ue,p(y.value.url),1),e[11]||(e[11]=a("p",{class:"card-status"},"Memproses data pengguna...",-1))])])])):E("",!0),v.value?(g(),f("div",de,[e[15]||(e[15]=a("h3",null,"Informasi Pengguna",-1)),a("div",ce,[e[14]||(e[14]=a("div",{class:"user-avatar"},[a("i",{class:"pi pi-user"})],-1)),a("div",ve,[a("h4",null,p(v.value.name),1),a("p",null,p(v.value.email),1)])]),a("div",pe,[d(u,{label:"Sholat",icon:"pi pi-check",onClick:e[2]||(e[2]=o=>I("sholat")),class:"p-button-success"}),d(u,{label:"Berhalangan",icon:"pi pi-times",onClick:e[3]||(e[3]=o=>I("halangan")),class:"p-button-warning"})])])):E("",!0),b.value.length>0?(g(),f("div",me,[e[17]||(e[17]=a("h3",null,"Riwayat Scan Terbaru",-1)),d(S,{value:b.value,paginator:!0,rows:5},{list:_(o=>[(g(!0),f(J,null,Y(o.items,(F,z)=>(g(),f("div",{class:"history-item",key:z},[a("div",fe,[a("div",ge,[e[16]||(e[16]=a("i",{class:"pi pi-user"},null,-1)),a("span",null,p(F.userName),1)]),a("div",{class:T(["history-status",F.status])},p(F.statusLabel),3),a("div",ye,p(F.time),1)])]))),128))]),_:1},8,["value"])])):E("",!0)]),_:1}),d(H,{visible:h.value,"onUpdate:visible":e[7]||(e[7]=o=>h.value=o),style:{width:"450px"},header:"Konfirmasi Kehadiran",modal:!0},{footer:_(()=>[d(u,{label:"Batal",icon:"pi pi-times",onClick:e[4]||(e[4]=o=>h.value=!1),class:"p-button-text"}),d(u,{label:"Berhalangan",icon:"pi pi-times",onClick:e[5]||(e[5]=o=>P("halangan")),class:"p-button-warning"}),d(u,{label:"Sholat",icon:"pi pi-check",onClick:e[6]||(e[6]=o=>P("sholat")),class:"p-button-success"})]),default:_(()=>[a("div",he,[e[18]||(e[18]=a("i",{class:"pi pi-exclamation-triangle"},null,-1)),a("span",null,"Apakah "+p(x.value)+" melakukan sholat pada "+p(K(w.value))+"?",1)])]),_:1},8,["visible"])])}}},Se=X(be,[["__scopeId","data-v-0f0e045b"]]);export{Se as default};
