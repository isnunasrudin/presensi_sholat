import{r as p,o as he,c as m,e as a,y as o,j as h,q as _,k as we,d as i,p as H,s as v,R as x,F as le,A as se,t as r,v as f,h as D,l as E,D as Ce}from"./vue-Bki0M6Jk.js";import{u as Ve,a as j}from"./app-Df4oPpsR.js";import{x as je,y as Se,o as Ue}from"./primevue-BWgMG8pc.js";import{U as $e}from"./UserMonthlyCalendar-CpcmlH4y.js";import{_ as De}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ie={class:"users"},Te={class:"page-header"},xe={class:"header-actions"},Re={class:"filters"},Be={class:"filter-group"},Fe={class:"filter-group"},Ee={class:"user-avatar-section"},Le={class:"user-avatar"},Me=["src","alt"],Pe={key:1,class:"pi pi-user"},Ae={class:"user-main-info"},Ne={class:"user-name-wrapper"},Oe={class:"user-name"},ze={class:"user-email"},Je={class:"user-details"},Ge={class:"detail-item"},He={class:"detail-content"},qe={class:"detail-value"},Ke={class:"detail-item"},We={class:"detail-content"},Qe={class:"detail-value"},Xe={class:"item-actions"},Ye={class:"table-avatar"},Ze=["src","alt"],ea={key:1,class:"pi pi-user table-avatar-icon"},aa={class:"action-buttons"},la={class:"field"},sa={key:0,class:"p-error"},oa={class:"field"},ta={key:0,class:"p-error"},na={class:"field"},ia={key:0,class:"p-error"},ra={class:"field"},da={key:0,class:"p-error"},ua={class:"field"},ma={key:0,class:"p-error"},pa={class:"field"},ca={for:"password"},va={key:0,class:"p-error"},ga={class:"dialog-actions"},ba={class:"dialog-form"},_a={class:"field"},fa={class:"field"},ya={class:"field"},ka={key:0,class:"file-name"},ha={key:1,class:"p-error"},wa={key:0,class:"import-result"},Ca={class:"result-header"},Va={class:"result-stats"},ja={class:"stat"},Sa={class:"stat-value success"},Ua={class:"stat"},$a={class:"stat-value error"},Da={key:0,class:"result-errors"},Ia={class:"error-list"},Ta={key:0,class:"more-errors"},xa={class:"dialog-actions"},Ra={__name:"Users",setup(Ba){const w=Ve(),g=je(),oe=Se(),L=p([]),R=p(!1),M=p(!1),I=p(!1),U=p("create"),u=p({}),P=p(!1),A=p(null),N=p([]),B=p(!1),O=p(!1),b=p({file:null,rombongan_belajar_id:null}),y=p({}),c=p(null),T=p(null),$=p({role:null,search:""}),C=p({current_page:1,per_page:15,total:0}),q=[{label:"All Roles",value:null},{label:"Admin",value:"admin"},{label:"User",value:"user"}],te=[{label:"Laki-laki",value:"male"},{label:"Perempuan",value:"female"}],d=p({id:null,name:"",email:"",role:"user",gender:null,password:"",rombongan_belajar_id:null});let K=null;const ne=()=>{clearTimeout(K),K=setTimeout(()=>{V()},500)},V=async()=>{R.value=!0;try{const l={page:C.value.current_page,...$.value},e=await j.get("/users",{params:l}),n=e.data.data.map(k=>({...k,photo:k.photo?`/storage/${k.photo}`:null}));L.value=n,C.value={current_page:e.data.current_page,per_page:e.data.per_page,total:e.data.total}}catch{g.add({severity:"error",summary:"Error",detail:"Failed to fetch users",life:3e3})}finally{R.value=!1}},ie=async()=>{try{const l=await j.get("/rombongan-belajar",{params:{per_page:1e3}});N.value=[{label:"Tidak ada rombongan",value:null},...l.data.data.map(e=>({label:`${e.nama_rombel} (${e.tingkat} - ${e.tahun_angkatan})`,value:e.id}))]}catch(l){console.error("Failed to fetch rombongan options:",l)}},z=(l=null)=>{u.value={},l?(U.value="edit",d.value={id:l.id,name:l.name,email:l.email,role:l.role,gender:l.gender||null,password:"",rombongan_belajar_id:l.rombongan_belajar_id||null}):(U.value="create",d.value={id:null,name:"",email:"",role:"user",gender:null,password:"",rombongan_belajar_id:null}),I.value=!0},re=async()=>{u.value={},M.value=!0;try{const l={name:d.value.name,email:d.value.email,role:d.value.role,gender:d.value.gender,rombongan_belajar_id:d.value.rombongan_belajar_id};d.value.password&&(l.password=d.value.password),U.value==="edit"?(await j.put(`/users/${d.value.id}`,l),g.add({severity:"success",summary:"Success",detail:"User updated successfully",life:3e3})):(await j.post("/users",l),g.add({severity:"success",summary:"Success",detail:"User created successfully",life:3e3})),I.value=!1,V()}catch(l){l.response?.data?.errors?u.value=l.response.data.errors:g.add({severity:"error",summary:"Error",detail:l.response?.data?.message||"Failed to save user",life:3e3})}finally{M.value=!1}},W=l=>{oe.require({message:`Are you sure you want to delete user "${l.name}"?`,header:"Confirm Delete",icon:"pi pi-exclamation-triangle",accept:()=>de(l.id)})},de=async l=>{try{await j.delete(`/users/${l}`),g.add({severity:"success",summary:"Success",detail:"User deleted successfully",life:3e3}),V()}catch(e){g.add({severity:"error",summary:"Error",detail:e.response?.data?.message||"Failed to delete user",life:3e3})}},ue=()=>{$.value={role:null,search:""},V()},me=l=>{C.value.current_page=l.page+1,V()},Q=l=>new Date(l).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"}),X=l=>l.charAt(0).toUpperCase()+l.slice(1),Y=l=>l==="admin"?"role-badge admin":"role-badge user",Z=async l=>{try{const e=await j.post(`/impersonate/${l.id}`);w.token=e.data.token,w.user=e.data.user,w.isImpersonating=!0,w.originalAdminId=e.data.original_admin_id,localStorage.setItem("token",e.data.token),localStorage.setItem("user",JSON.stringify(e.data.user)),localStorage.setItem("is_impersonating","true"),localStorage.setItem("original_admin_id",e.data.original_admin_id),g.add({severity:"success",summary:"Success",detail:`Now logged in as ${l.name}`,life:3e3}),setTimeout(()=>{window.location.href="/"},1e3)}catch(e){g.add({severity:"error",summary:"Error",detail:e.response?.data?.message||"Failed to impersonate user",life:3e3})}},ee=l=>{A.value=l,P.value=!0},pe=()=>{b.value={file:null,rombongan_belajar_id:null},y.value={},c.value=null,T.value&&(T.value.value=""),B.value=!0},ce=()=>{B.value=!1,b.value={file:null,rombongan_belajar_id:null},y.value={},c.value=null,T.value&&(T.value.value=""),V()},ve=l=>{const e=l.target.files[0];if(e){if(e.type!=="text/csv"&&!e.name.endsWith(".csv")){y.value.file="File harus berformat CSV",b.value.file=null;return}b.value.file=e,y.value.file=""}},ge=async()=>{try{const l=await j.get("/users/import/template",{responseType:"blob"}),e=window.URL.createObjectURL(new Blob([l.data])),n=document.createElement("a");n.href=e,n.setAttribute("download","user_import_template.csv"),document.body.appendChild(n),n.click(),n.remove(),g.add({severity:"success",summary:"Berhasil",detail:"Template CSV berhasil didownload",life:3e3})}catch{g.add({severity:"error",summary:"Error",detail:"Gagal mendownload template",life:3e3})}},be=async()=>{if(!b.value.file){y.value.file="File CSV harus dipilih";return}O.value=!0,y.value={};try{const l=new FormData;l.append("file",b.value.file),b.value.rombongan_belajar_id&&l.append("rombongan_belajar_id",b.value.rombongan_belajar_id);const e=await j.post("/users/import",l,{headers:{"Content-Type":"multipart/form-data"}});c.value={success:e.data.skipped_count===0,message:e.data.message,imported_count:e.data.imported_count,skipped_count:e.data.skipped_count,errors:e.data.errors||[]},e.data.imported_count>0&&g.add({severity:"success",summary:"Import Selesai",detail:`${e.data.imported_count} siswa berhasil diimport`,life:5e3}),e.data.skipped_count>0&&g.add({severity:"warn",summary:"Perhatian",detail:`${e.data.skipped_count} baris dilewati karena error`,life:5e3})}catch(l){l.response?.data?.errors&&(y.value=l.response.data.errors),g.add({severity:"error",summary:"Error",detail:l.response?.data?.message||"Gagal mengimport data",life:3e3})}finally{O.value=!1}};return he(()=>{V(),ie()}),(l,e)=>{const n=h("Button"),k=h("Dropdown"),J=h("InputText"),S=h("Column"),_e=h("DataTable"),fe=h("Paginator"),ye=h("Card"),ke=h("Password"),ae=h("Dialog"),F=we("tooltip");return i(),m("div",Ie,[a("div",Te,[e[15]||(e[15]=a("h1",{class:"page-title"},"Manajemen Pengguna",-1)),a("div",xe,[o(n,{label:"Import CSV",icon:"pi pi-upload",onClick:e[0]||(e[0]=s=>pe()),severity:"info"}),o(n,{label:"Tambah Pengguna",icon:"pi pi-plus",onClick:e[1]||(e[1]=s=>z())})])]),o(ye,null,{content:_(()=>[a("div",Re,[a("div",Be,[e[16]||(e[16]=a("label",null,"Peran",-1)),o(k,{modelValue:$.value.role,"onUpdate:modelValue":e[2]||(e[2]=s=>$.value.role=s),options:q,optionLabel:"label",optionValue:"value",placeholder:"Semua Peran",onChange:V},null,8,["modelValue"])]),a("div",Fe,[e[17]||(e[17]=a("label",null,"Cari",-1)),o(J,{modelValue:$.value.search,"onUpdate:modelValue":e[3]||(e[3]=s=>$.value.search=s),placeholder:"Cari berdasarkan nama atau email",onInput:ne},null,8,["modelValue"])]),o(n,{label:"Hapus Filter",icon:"pi pi-filter-slash",onClick:ue,severity:"secondary"})]),o(x(Ue),{value:L.value,loading:R.value,class:"user-dataview"},{list:_(s=>[(i(!0),m(le,null,se(s.items,t=>(i(),m("div",{class:"dataview-item",key:t.id},[a("div",Ee,[a("div",Le,[t.photo?(i(),m("img",{key:0,src:`${t.photo}`,alt:t.name},null,8,Me)):(i(),m("i",Pe))]),a("div",Ae,[a("div",Ne,[a("h3",Oe,r(t.name),1),a("span",{class:f(Y(t.role))},r(X(t.role)),3)]),a("p",ze,[e[18]||(e[18]=a("i",{class:"pi pi-envelope"},null,-1)),D(" "+r(t.email),1)])])]),a("div",Je,[a("div",Ge,[e[20]||(e[20]=a("i",{class:"pi pi-graduation-cap detail-icon"},null,-1)),a("div",He,[e[19]||(e[19]=a("span",{class:"detail-label"},"Rombongan Belajar",-1)),a("span",qe,r(t.rombongan_belajar?`${t.rombongan_belajar.nama_rombel} (${t.rombongan_belajar.tingkat})`:"-"),1)])]),a("div",Ke,[e[22]||(e[22]=a("i",{class:"pi pi-calendar detail-icon"},null,-1)),a("div",We,[e[21]||(e[21]=a("span",{class:"detail-label"},"Anggota Sejak",-1)),a("span",Qe,r(Q(t.created_at)),1)])])]),a("div",Xe,[o(n,{icon:"pi pi-calendar",label:"Lihat Rekap",onClick:G=>ee(t),severity:"success",size:"small",outlined:"",class:"w-full"},null,8,["onClick"]),t.role!=="admin"&&t.id!==x(w).user.id?(i(),H(n,{key:0,icon:"pi pi-sign-in",label:"Masuk sebagai",onClick:G=>Z(t),severity:"warning",size:"small",outlined:""},null,8,["onClick"])):v("",!0),o(n,{icon:"pi pi-pencil",label:"Edit",onClick:G=>z(t),severity:"info",size:"small",outlined:""},null,8,["onClick"]),o(n,{icon:"pi pi-trash",label:"Hapus",onClick:G=>W(t),severity:"danger",size:"small",outlined:"",disabled:t.id===x(w).user.id},null,8,["onClick","disabled"])])]))),128))]),empty:_(()=>[...e[23]||(e[23]=[a("div",{class:"empty-state"},[a("i",{class:"pi pi-users",style:{"font-size":"3rem",color:"#9ca3af"}}),a("p",null,"Tidak ada pengguna ditemukan")],-1)])]),_:1},8,["value","loading"]),o(_e,{value:L.value,loading:R.value,responsiveLayout:"scroll",class:"mt-4 desktop-table w-full"},{default:_(()=>[o(S,{header:"Foto"},{body:_(s=>[a("div",Ye,[s.data.photo?(i(),m("img",{key:0,src:`${s.data.photo}`,alt:s.data.name,class:"table-avatar-img"},null,8,Ze)):(i(),m("i",ea))])]),_:1}),o(S,{field:"name",header:"Nama"}),o(S,{field:"email",header:"Email"}),o(S,{field:"role",header:"Peran"},{body:_(s=>[a("span",{class:f(Y(s.data.role))},r(X(s.data.role)),3)]),_:1}),o(S,{header:"Rombongan Belajar"},{body:_(s=>[D(r(s.data.rombongan_belajar?`${s.data.rombongan_belajar.nama_rombel} (${s.data.rombongan_belajar.tingkat})`:"-"),1)]),_:1}),o(S,{field:"created_at",header:"Bergabung"},{body:_(s=>[D(r(Q(s.data.created_at)),1)]),_:1}),o(S,{header:"Aksi"},{body:_(s=>[a("div",aa,[E(o(n,{icon:"pi pi-calendar",onClick:t=>ee(s.data),severity:"success",text:"",rounded:""},null,8,["onClick"]),[[F,"Lihat Rekap",void 0,{top:!0}]]),s.data.role!=="admin"&&s.data.id!==x(w).user.id?E((i(),H(n,{key:0,icon:"pi pi-sign-in",onClick:t=>Z(s.data),severity:"warning",text:"",rounded:""},null,8,["onClick"])),[[F,"Masuk sebagai pengguna ini",void 0,{top:!0}]]):v("",!0),E(o(n,{icon:"pi pi-pencil",onClick:t=>z(s.data),severity:"info",text:"",rounded:""},null,8,["onClick"]),[[F,"Edit",void 0,{top:!0}]]),E(o(n,{icon:"pi pi-trash",onClick:t=>W(s.data),severity:"danger",text:"",rounded:"",disabled:s.data.id===x(w).user.id},null,8,["onClick","disabled"]),[[F,"Hapus",void 0,{top:!0}]])])]),_:1})]),_:1},8,["value","loading"]),C.value.total>0?(i(),H(fe,{key:0,rows:C.value.per_page,totalRecords:C.value.total,first:(C.value.current_page-1)*C.value.per_page,onPage:me,class:"mt-4"},null,8,["rows","totalRecords","first"])):v("",!0)]),_:1}),o(ae,{visible:I.value,"onUpdate:visible":e[11]||(e[11]=s=>I.value=s),header:U.value==="create"?"Tambah Pengguna":"Edit Pengguna",modal:!0,style:{width:"500px"}},{default:_(()=>[a("form",{onSubmit:Ce(re,["prevent"]),class:"dialog-form"},[a("div",la,[e[24]||(e[24]=a("label",{for:"name"},"Nama Lengkap *",-1)),o(J,{id:"name",modelValue:d.value.name,"onUpdate:modelValue":e[4]||(e[4]=s=>d.value.name=s),placeholder:"Masukkan nama lengkap",class:f({"p-invalid":u.value.name})},null,8,["modelValue","class"]),u.value.name?(i(),m("small",sa,r(u.value.name),1)):v("",!0)]),a("div",oa,[e[25]||(e[25]=a("label",{for:"email"},"Email *",-1)),o(J,{id:"email",modelValue:d.value.email,"onUpdate:modelValue":e[5]||(e[5]=s=>d.value.email=s),type:"email",placeholder:"Masukkan email",class:f({"p-invalid":u.value.email})},null,8,["modelValue","class"]),u.value.email?(i(),m("small",ta,r(u.value.email),1)):v("",!0)]),a("div",na,[e[26]||(e[26]=a("label",{for:"role"},"Peran *",-1)),o(k,{id:"role",modelValue:d.value.role,"onUpdate:modelValue":e[6]||(e[6]=s=>d.value.role=s),options:q.filter(s=>s.value),optionLabel:"label",optionValue:"value",placeholder:"Pilih peran",class:f({"p-invalid":u.value.role})},null,8,["modelValue","options","class"]),u.value.role?(i(),m("small",ia,r(u.value.role),1)):v("",!0)]),a("div",ra,[e[27]||(e[27]=a("label",{for:"gender"},"Jenis Kelamin",-1)),o(k,{id:"gender",modelValue:d.value.gender,"onUpdate:modelValue":e[7]||(e[7]=s=>d.value.gender=s),options:te,optionLabel:"label",optionValue:"value",placeholder:"Pilih jenis kelamin",showClear:"",class:f({"p-invalid":u.value.gender})},null,8,["modelValue","class"]),u.value.gender?(i(),m("small",da,r(u.value.gender),1)):v("",!0)]),a("div",ua,[e[28]||(e[28]=a("label",{for:"rombongan_belajar"},"Rombongan Belajar",-1)),o(k,{id:"rombongan_belajar",modelValue:d.value.rombongan_belajar_id,"onUpdate:modelValue":e[8]||(e[8]=s=>d.value.rombongan_belajar_id=s),options:N.value,optionLabel:"label",optionValue:"value",placeholder:"Pilih rombongan belajar",class:f({"p-invalid":u.value.rombongan_belajar_id}),showClear:""},null,8,["modelValue","options","class"]),u.value.rombongan_belajar_id?(i(),m("small",ma,r(u.value.rombongan_belajar_id),1)):v("",!0)]),a("div",pa,[a("label",ca,"Kata Sandi "+r(U.value==="edit"?"(kosongkan untuk tetap menggunakan yang sekarang)":"*"),1),o(ke,{id:"password",modelValue:d.value.password,"onUpdate:modelValue":e[9]||(e[9]=s=>d.value.password=s),placeholder:"Masukkan kata sandi",feedback:U.value==="create",toggleMask:"",class:f({"p-invalid":u.value.password})},null,8,["modelValue","feedback","class"]),u.value.password?(i(),m("small",va,r(u.value.password),1)):v("",!0)]),a("div",ga,[o(n,{label:"Batal",onClick:e[10]||(e[10]=s=>I.value=!1),severity:"secondary",text:""}),o(n,{type:"submit",label:"Simpan",loading:M.value},null,8,["loading"])])],32)]),_:1},8,["visible","header"]),o(ae,{visible:B.value,"onUpdate:visible":e[13]||(e[13]=s=>B.value=s),header:"Import Siswa dari CSV",modal:!0,style:{width:"600px"}},{default:_(()=>[a("div",ba,[e[38]||(e[38]=a("div",{class:"info-message"},[a("i",{class:"pi pi-info-circle"}),a("div",null,[a("p",null,[a("strong",null,"Cara Import Siswa:")]),a("ul",null,[a("li",null,[a("strong",null,"Pilih Rombongan Manual:"),D(" Pilih rombongan di dropdown, semua siswa akan masuk ke rombongan tersebut")]),a("li",null,[a("strong",null,"Import dengan Data Rombongan:"),D(" Tambahkan kolom nama_rombel, tingkat, dan tahun_angkatan di CSV. Sistem akan otomatis membuat rombongan baru jika belum ada")])]),a("p",{class:"note"},"Jika rombongan manual dipilih, data rombongan di CSV akan diabaikan.")])],-1)),a("div",_a,[e[29]||(e[29]=a("label",null,"Template CSV",-1)),o(n,{label:"Download Template",icon:"pi pi-download",onClick:ge,severity:"secondary",outlined:"",class:"w-full"}),e[30]||(e[30]=a("small",{class:"help-text"},"Template berisi contoh format CSV yang diperlukan",-1))]),a("div",fa,[e[31]||(e[31]=a("label",{for:"import_rombongan"},"Rombongan Belajar (Opsional)",-1)),o(k,{id:"import_rombongan",modelValue:b.value.rombongan_belajar_id,"onUpdate:modelValue":e[12]||(e[12]=s=>b.value.rombongan_belajar_id=s),options:N.value,optionLabel:"label",optionValue:"value",placeholder:"Pilih rombongan belajar",showClear:"",class:"w-full"},null,8,["modelValue","options"]),e[32]||(e[32]=a("small",{class:"help-text"},"Jika dipilih, semua siswa yang diimport akan otomatis masuk ke rombongan ini",-1))]),a("div",ya,[e[34]||(e[34]=a("label",{for:"csv_file"},"File CSV *",-1)),a("input",{type:"file",id:"csv_file",ref_key:"fileInput",ref:T,onChange:ve,accept:".csv",class:"file-input"},null,544),b.value.file?(i(),m("small",ka,[e[33]||(e[33]=a("i",{class:"pi pi-file"},null,-1)),D(" "+r(b.value.file.name),1)])):v("",!0),y.value.file?(i(),m("small",ha,r(y.value.file),1)):v("",!0)]),c.value?(i(),m("div",wa,[a("div",{class:f(["result-card",c.value.success?"success":"warning"])},[a("div",Ca,[a("i",{class:f(["pi",c.value.success?"pi-check-circle":"pi-exclamation-triangle"])},null,2),a("h4",null,r(c.value.message),1)]),a("div",Va,[a("div",ja,[e[35]||(e[35]=a("span",{class:"stat-label"},"Berhasil:",-1)),a("span",Sa,r(c.value.imported_count),1)]),a("div",Ua,[e[36]||(e[36]=a("span",{class:"stat-label"},"Gagal:",-1)),a("span",$a,r(c.value.skipped_count),1)])]),c.value.errors&&c.value.errors.length>0?(i(),m("div",Da,[e[37]||(e[37]=a("h5",null,"Detail Error:",-1)),a("div",Ia,[(i(!0),m(le,null,se(c.value.errors.slice(0,5),(s,t)=>(i(),m("div",{key:t,class:"error-item"},[a("strong",null,"Baris "+r(s.row)+":",1),a("span",null,r(Object.values(s.errors).flat().join(", ")),1)]))),128)),c.value.errors.length>5?(i(),m("div",Ta," + "+r(c.value.errors.length-5)+" error lainnya ",1)):v("",!0)])])):v("",!0)],2)])):v("",!0),a("div",xa,[o(n,{label:"Tutup",onClick:ce,severity:"secondary",text:""}),o(n,{label:"Import",icon:"pi pi-upload",onClick:be,disabled:!b.value.file,loading:O.value},null,8,["disabled","loading"])])])]),_:1},8,["visible"]),o($e,{visible:P.value,"onUpdate:visible":e[14]||(e[14]=s=>P.value=s),userId:A.value?.id,userName:A.value?.name},null,8,["visible","userId","userName"])])}}},Aa=De(Ra,[["__scopeId","data-v-8685601c"]]);export{Aa as default};
